kind: MLApp
metadata:
  name: tensorflow
spec:
  package_manager: "pip2"
  packages:
    - names:
      {{- range $i, $value := .packages }}
      - "{{ $value }}"
      {{- end }}
      manager: "pip2"
  tasks:
  - name: train
    resources:
    - name: worker
      replicas: 1
      restartPolicy: Never
      maxRestartCount: 0
      allowFail: true
      images:
        gpu: "kuberlab/pyspark:cpu-27-full"
        cpu: "kuberlab/pyspark:cpu-27-full"
      command: >-
        python train.py --master {{ .sparkMaster }}
        --executor-cores 4 --batch-size 20
        --output-dir $TRAINING_DIR/$BUILD_ID
      workdir: "$SRC_DIR"
      resources:
        accelerators:
          gpu: 0
        requests:
          cpu: 100m
          memory: 512M
        limits:
          cpu: 1000m
          memory: 2Gi
      default_volume_mapping: true
  - name: inference
    resources:
    - name: worker
      replicas: 1
      restartPolicy: Never
      maxRestartCount: 0
      allowFail: true
      images:
        gpu: "kuberlab/pyspark:cpu-27-full"
        cpu: "kuberlab/pyspark:cpu-27-full"
      command: >-
        python inference.py --model-dir $TRAINING_DIR/1 --input examples --executor-cores 4 --master {{ .sparkMaster }}
      workdir: "$SRC_DIR"
      resources:
        accelerators:
          gpu: 0
        requests:
          cpu: 100m
          memory: 512M
        limits:
          cpu: 1000m
          memory: 2Gi
      default_volume_mapping: true

  uix:
  - name: jupyter
    displayName: Jupyter
    images:
      gpu: "kuberlab/pyspark:cpu-27-full"
      cpu: "kuberlab/pyspark:cpu-27-full"
    resources:
      requests:
        cpu: 100m
        memory: 64Mi
      limits:
        cpu: 1000m
        memory: 4Gi
    ports:
    - port: 8888
      targetPort: 8888
      protocol: TCP
      name: http
    default_volume_mapping: true
  volumes:
  - isLibDir: false
    mountPath: /notebooks/training
    name: training
    clusterStorage: {{ .storage.value }}
    subPath: training
  - gitRepo:
      repository: https://github.com/kuberlab-catalog/pyspark-mnist
    isLibDir: false
    mountPath: /notebooks/src
    name: src
    subPath: pyspark-mnist/src
  - isLibDir: true
    mountPath: /notebooks/lib
    name: lib
    clusterStorage: {{ .storage.value }}
    subPath: lib
  - isLibDir: false
    mountPath: /notebooks
    name: code
    subPath: code
    clusterStorage: {{ .storage.value }}
  - isLibDir: false
    mountPath: /notebooks/data
    name: data
    datasetFS:
      workspace: {{ .dataset.workspace }}
      dataset: {{ .dataset.value }}
      version: {{ .dataset.version }}
